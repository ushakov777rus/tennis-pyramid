"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { NavigationBar } from "@/app/components/NavigationBar";
import { TournamentsRepository } from "@/app/repositories/TournamentsRepository";
import { Tournament } from "@/app/models/Tournament";
import { formatDate } from "@/app/components/Utils"; // –µ—Å–ª–∏ –µ—Å—Ç—å

import "./MainPage.css";
import { useUser } from "./components/UserContext";
import { GuestMainPageCard } from "./components/GuestMainPageCard";
import { AuthContainer } from "./components/AuthContainer";

export default function HomePage() {
  const { user } = useUser();
  const router = useRouter();
  const [ongoing, setOngoing] = useState<Tournament[]>([]);
  const [loading, setLoading] = useState(true);
  const [isLoginOpen, setIsLoginOpen] = useState(false);
  const [signupRole, setSignupRole] = useState<"player" | "tournament_admin">("player"); 

  const isGuest = !user;

  useEffect(() => {
    (async () => {
      try {

        const list = await TournamentsRepository.loadAll(); // <- –≥–æ—Ç–æ–≤—ã–π –º–µ—Ç–æ–¥
        setOngoing(list.slice(0, 3));
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  return (
    <div className="page-container">
      <NavigationBar />
      <h1 className="page-title">–¢–µ–Ω–Ω–∏—Å–Ω—ã–µ —Ç—É—Ä–Ω–∏—Ä—ã</h1>

      <main className="page-content-container">
        <section className="section">
          <h2 className="section-title">–ë–ª–∏–∂–∞–π—à–∏–µ —Ç—É—Ä–Ω–∏—Ä—ã</h2>

          <div className="card-grid">
            {loading && [1,2,3].map(i => (
              <div className="card card-250px" key={`s-${i}`}>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
            ))}

            {!loading && ongoing.map(t => (
              <div className="card card-250px card-with-status" key={t.id}>
                <div className="tournament-status">  
                  <span
                    className={`status ${
                      t.status === "finished"
                        ? "finished"
                        : t.status === "ongoing"
                        ? "ongoing"
                        : "draft"
                    }`}
                  >
                    { t.getStatus() }
                  </span>
                </div>
                <div className="card-icon">üèÜ</div>
                <div className="card-date">
                  {t.name}
                </div>
                <div className="card-date">
                  {t.start_date ? `${formatDate(new Date(t.start_date))} ‚Äî ${t.end_date ? formatDate(new Date(t.end_date)) : "‚Ä¶"}` : `${t.start_date ?? ""}`}
                </div>
                <button
                  className="card-btn card-btn-act"
                  onClick={() => router.push(`/tournaments/${t.id}`)}
                >
                  –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                </button>
              </div>
            ))}

            {!loading && ongoing.length === 0 && (
              <div className="card card-250px">–°–µ–π—á–∞—Å —Ç—É—Ä–Ω–∏—Ä–æ–≤ –Ω–µ—Ç</div>
            )}

            <div className="card card-80px card-all" onClick={() => router.push("/tournaments")}>
              –í—Å–µ
            </div>
          </div>
        </section>

        
        {isGuest && (
          <section className="section">
            <GuestMainPageCard
              onSignupPlayer={() => {              // üëá –∫–ª–∏–∫ –ø–æ ¬´—É—á–∞—Å—Ç–Ω–∏–∫¬ª
                setSignupRole("player");
                setIsLoginOpen(true);
              }}
              onSignupAdmin={() => {               // üëá –∫–ª–∏–∫ –ø–æ ¬´–æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä¬ª
                setSignupRole("tournament_admin");
                setIsLoginOpen(true);
              }}
            />
          </section>
        )}
      </main>

      <footer className="card page-footer">
          <div className="footer-section left">
            <h3>–î–ª—è —Å–≤—è–∑–∏</h3>
            <p>
              <a href="mailto:honey.cup@yandex.ru">honey.cup@yandex.ru</a>
            </p>
          </div>
          <div className="footer-section right">
            <h3>¬© {new Date().getFullYear()} HoneyCup</h3>
            <p>–í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã</p>
          </div>        
      </footer>


      <AuthContainer
        isOpen={isLoginOpen}
        onClose={() => setIsLoginOpen(false)}
        initialMode="register"
        initialRole={signupRole}
      />
    </div>
  );
}